#Varaibles
# set env by export var="var"
tenantName=$1
admin_user=$adminUsername #env-variable
admin_pass=$adminPass
url=$grafanaUrl

echo "tenantName: $tenantName"
echo "admin_user: $admin_user"
echo "admin_pass: $(echo $admin_pass | head -c-40)..."
echo "url: $url"
echo "=========="

#==========================DASHBOARDS=================================
lokiQuicksearchDashboard="{ \"annotations\": { \"list\": [ { \"builtIn\": 1, \"datasource\": \"-- Grafana --\", \"enable\": true, \"hide\": true, \"iconColor\": \"rgba(0, 211, 255, 1)\", \"name\": \"Annotations & Alerts\", \"type\": \"dashboard\" } ] }, \"description\": \"Loki logs panel with prometheus variables \", \"editable\": true, \"gnetId\": 12019, \"graphTooltip\": 0, \"id\": null, \"iteration\": 1629266148215, \"links\": [], \"panels\": [ { \"aliasColors\": {}, \"bars\": false, \"dashLength\": 10, \"dashes\": false, \"datasource\": \"Loki\", \"fieldConfig\": { \"defaults\": { \"links\": [] }, \"overrides\": [] }, \"fill\": 1, \"fillGradient\": 0, \"gridPos\": { \"h\": 9, \"w\": 24, \"x\": 0, \"y\": 0 }, \"hiddenSeries\": false, \"id\": 4, \"legend\": { \"alignAsTable\": false, \"avg\": false, \"current\": true, \"hideEmpty\": true, \"hideZero\": true, \"max\": false, \"min\": false, \"rightSide\": false, \"show\": false, \"total\": false, \"values\": true }, \"lines\": true, \"linewidth\": 1, \"nullPointMode\": \"null\", \"options\": { \"alertThreshold\": true }, \"percentage\": false, \"pluginVersion\": \"7.5.3\", \"pointradius\": 2, \"points\": false, \"renderer\": \"flot\", \"seriesOverrides\": [], \"spaceLength\": 10, \"stack\": false, \"steppedLine\": false, \"targets\": [ { \"expr\": \"sum(rate({namespace=~\\\"$namespace\\\",app=~\\\"$app\\\", level=~\\\"$level\\\"} |= \\\"$search\\\" [5m] )) by (namespace,app,pod)\", \"refId\": \"A\" } ], \"thresholds\": [], \"timeFrom\": null, \"timeRegions\": [], \"timeShift\": null, \"title\": \"Log rate\", \"tooltip\": { \"shared\": false, \"sort\": 0, \"value_type\": \"individual\" }, \"type\": \"graph\", \"xaxis\": { \"buckets\": null, \"mode\": \"time\", \"name\": null, \"show\": true, \"values\": [] }, \"yaxes\": [ { \"format\": \"short\", \"label\": null, \"logBase\": 1, \"max\": null, \"min\": null, \"show\": true }, { \"format\": \"short\", \"label\": null, \"logBase\": 1, \"max\": null, \"min\": null, \"show\": false } ], \"yaxis\": { \"align\": false, \"alignLevel\": null } }, { \"datasource\": \"Loki\", \"fieldConfig\": { \"defaults\": {}, \"overrides\": [] }, \"gridPos\": { \"h\": 30, \"w\": 24, \"x\": 0, \"y\": 9 }, \"id\": 2, \"maxDataPoints\": \"\", \"options\": { \"dedupStrategy\": \"none\", \"showLabels\": false, \"showTime\": true, \"sortOrder\": \"Descending\", \"wrapLogMessage\": true }, \"targets\": [ { \"expr\": \"{namespace=~\\\"$namespace\\\",app=~\\\"$app\\\", level=~\\\"$level\\\"} |= \\\"$search\\\" \", \"refId\": \"A\" } ], \"timeFrom\": null, \"timeShift\": null, \"title\": \"Logs Panel\", \"type\": \"logs\" } ], \"refresh\": false, \"schemaVersion\": 27, \"style\": \"dark\", \"tags\": [], \"templating\": { \"list\": [ { \"allValue\": \".*\", \"current\": { \"selected\": false, \"text\": \"All\", \"value\": \"$__all\" }, \"datasource\": \"prometheus\", \"definition\": \"label_values(namespace)\", \"description\": null, \"error\": null, \"hide\": 0, \"includeAll\": true, \"label\": null, \"multi\": false, \"name\": \"namespace\", \"options\": [], \"query\": { \"query\": \"label_values(namespace)\", \"refId\": \"prometheus-namespace-Variable-Query\" }, \"refresh\": 1, \"regex\": \"\", \"skipUrlSync\": false, \"sort\": 1, \"tagValuesQuery\": \"\", \"tags\": [], \"tagsQuery\": \"\", \"type\": \"query\", \"useTags\": false }, { \"allValue\": \".*\", \"current\": { \"selected\": true, \"text\": [ \"All\" ], \"value\": [ \"$__all\" ] }, \"datasource\": \"Loki\", \"definition\": \"label_values(app)\", \"description\": null, \"error\": null, \"hide\": 0, \"includeAll\": true, \"label\": \"app\", \"multi\": true, \"name\": \"app\", \"options\": [], \"query\": \"label_values(app)\", \"refresh\": 2, \"regex\": \"\", \"skipUrlSync\": false, \"sort\": 1, \"tagValuesQuery\": \"\", \"tags\": [], \"tagsQuery\": \"\", \"type\": \"query\", \"useTags\": false }, { \"allValue\": \".*\", \"current\": { \"selected\": true, \"text\": [ \"All\" ], \"value\": [ \"$__all\" ] }, \"datasource\": \"prometheus\", \"definition\": \"label_values(pod)\", \"description\": null, \"error\": null, \"hide\": 2, \"includeAll\": true, \"label\": null, \"multi\": true, \"name\": \"pod\", \"options\": [], \"query\": { \"query\": \"label_values(pod)\", \"refId\": \"prometheus-pod-Variable-Query\" }, \"refresh\": 2, \"regex\": \"\", \"skipUrlSync\": false, \"sort\": 0, \"tagValuesQuery\": \"\", \"tags\": [], \"tagsQuery\": \"\", \"type\": \"query\", \"useTags\": false }, { \"allValue\": \".*\", \"current\": { \"selected\": true, \"text\": [ \"All\" ], \"value\": [ \"$__all\" ] }, \"datasource\": \"Loki\", \"definition\": \"label_values(level)\", \"description\": null, \"error\": null, \"hide\": 0, \"includeAll\": true, \"label\": \"level\", \"multi\": true, \"name\": \"level\", \"options\": [], \"query\": \"label_values(level)\", \"refresh\": 2, \"regex\": \"\", \"skipUrlSync\": false, \"sort\": 0, \"tagValuesQuery\": \"\", \"tags\": [], \"tagsQuery\": \"\", \"type\": \"query\", \"useTags\": false }, { \"current\": { \"selected\": false, \"text\": \"\", \"value\": \"\" }, \"description\": null, \"error\": null, \"hide\": 0, \"label\": null, \"name\": \"search\", \"options\": [ { \"selected\": true, \"text\": \"\", \"value\": \"\" } ], \"query\": \"\", \"skipUrlSync\": false, \"type\": \"textbox\" } ] }, \"time\": { \"from\": \"now-30m\", \"to\": \"now\" }, \"timepicker\": { \"refresh_intervals\": [ \"5s\", \"10s\", \"30s\", \"1m\", \"5m\", \"15m\", \"30m\", \"1h\", \"2h\", \"1d\" ] }, \"timezone\": \"\", \"title\": \"Loki Dashboard quick search\", \"uid\": \"liz0yRCZz\", \"version\": 1 }"

prometheusStatsDashboard="{ \"annotations\": { \"list\": [ { \"builtIn\": 1, \"datasource\": \"-- Grafana --\", \"enable\": true, \"hide\": true, \"iconColor\": \"rgba(0, 211, 255, 1)\", \"name\": \"Annotations & Alerts\", \"type\": \"dashboard\" } ] }, \"editable\": true, \"gnetId\": null, \"graphTooltip\": 0, \"id\": null, \"iteration\": 1629266355725, \"links\": [ { \"icon\": \"info\", \"tags\": [], \"targetBlank\": true, \"title\": \"Grafana Docs\", \"tooltip\": \"\", \"type\": \"link\", \"url\": \"https:\/\/grafana.com\/docs\/grafana\/latest\/\" }, { \"icon\": \"info\", \"tags\": [], \"targetBlank\": true, \"title\": \"Prometheus Docs\", \"type\": \"link\", \"url\": \"http:\/\/prometheus.io\/docs\/introduction\/overview\/\" } ], \"panels\": [ { \"cacheTimeout\": null, \"colorBackground\": false, \"colorValue\": false, \"colors\": [ \"rgba(245, 54, 54, 0.9)\", \"rgba(237, 129, 40, 0.89)\", \"rgba(50, 172, 45, 0.97)\" ], \"datasource\": \"prometheus\", \"decimals\": 1, \"editable\": true, \"error\": false, \"fieldConfig\": { \"defaults\": {}, \"overrides\": [] }, \"format\": \"s\", \"gauge\": { \"maxValue\": 100, \"minValue\": 0, \"show\": false, \"thresholdLabels\": false, \"thresholdMarkers\": true }, \"gridPos\": { \"h\": 5, \"w\": 6, \"x\": 0, \"y\": 0 }, \"id\": 5, \"interval\": null, \"links\": [], \"mappingType\": 1, \"mappingTypes\": [ { \"name\": \"value to text\", \"value\": 1 }, { \"name\": \"range to text\", \"value\": 2 } ], \"maxDataPoints\": 100, \"nullPointMode\": \"connected\", \"nullText\": null, \"postfix\": \"\", \"postfixFontSize\": \"50%\", \"prefix\": \"\", \"prefixFontSize\": \"50%\", \"rangeMaps\": [ { \"from\": \"null\", \"text\": \"N\/A\", \"to\": \"null\" } ], \"sparkline\": { \"fillColor\": \"rgba(31, 118, 189, 0.18)\", \"full\": false, \"lineColor\": \"rgb(31, 120, 193)\", \"show\": false }, \"tableColumn\": \"\", \"targets\": [ { \"expr\": \"(time() - process_start_time_seconds{job=\\\"prometheus\\\", instance=~\\\"$node\\\"})\", \"intervalFactor\": 2, \"refId\": \"A\" } ], \"thresholds\": \"\", \"title\": \"Uptime\", \"type\": \"singlestat\", \"valueFontSize\": \"80%\", \"valueMaps\": [ { \"op\": \"=\", \"text\": \"N\/A\", \"value\": \"null\" } ], \"valueName\": \"current\" }, { \"cacheTimeout\": null, \"colorBackground\": false, \"colorValue\": false, \"colors\": [ \"rgba(50, 172, 45, 0.97)\", \"rgba(237, 129, 40, 0.89)\", \"rgba(245, 54, 54, 0.9)\" ], \"datasource\": \"prometheus\", \"editable\": true, \"error\": false, \"fieldConfig\": { \"defaults\": {}, \"overrides\": [] }, \"format\": \"none\", \"gauge\": { \"maxValue\": 100, \"minValue\": 0, \"show\": false, \"thresholdLabels\": false, \"thresholdMarkers\": true }, \"gridPos\": { \"h\": 5, \"w\": 6, \"x\": 6, \"y\": 0 }, \"id\": 6, \"interval\": null, \"links\": [], \"mappingType\": 1, \"mappingTypes\": [ { \"name\": \"value to text\", \"value\": 1 }, { \"name\": \"range to text\", \"value\": 2 } ], \"maxDataPoints\": 100, \"nullPointMode\": \"connected\", \"nullText\": null, \"postfix\": \"\", \"postfixFontSize\": \"50%\", \"prefix\": \"\", \"prefixFontSize\": \"50%\", \"rangeMaps\": [ { \"from\": \"null\", \"text\": \"N\/A\", \"to\": \"null\" } ], \"sparkline\": { \"fillColor\": \"rgba(31, 118, 189, 0.18)\", \"full\": false, \"lineColor\": \"rgb(31, 120, 193)\", \"show\": true }, \"tableColumn\": \"\", \"targets\": [ { \"expr\": \"prometheus_local_storage_memory_series{instance=~\\\"$node\\\"}\", \"intervalFactor\": 2, \"refId\": \"A\" } ], \"thresholds\": \"1,5\", \"title\": \"Local Storage Memory Series\", \"type\": \"singlestat\", \"valueFontSize\": \"70%\", \"valueMaps\": [], \"valueName\": \"current\" }, { \"cacheTimeout\": null, \"colorBackground\": false, \"colorValue\": true, \"colors\": [ \"rgba(50, 172, 45, 0.97)\", \"rgba(237, 129, 40, 0.89)\", \"rgba(245, 54, 54, 0.9)\" ], \"datasource\": \"prometheus\", \"editable\": true, \"error\": false, \"fieldConfig\": { \"defaults\": {}, \"overrides\": [] }, \"format\": \"none\", \"gauge\": { \"maxValue\": 100, \"minValue\": 0, \"show\": false, \"thresholdLabels\": false, \"thresholdMarkers\": true }, \"gridPos\": { \"h\": 5, \"w\": 6, \"x\": 12, \"y\": 0 }, \"id\": 7, \"interval\": null, \"links\": [], \"mappingType\": 1, \"mappingTypes\": [ { \"name\": \"value to text\", \"value\": 1 }, { \"name\": \"range to text\", \"value\": 2 } ], \"maxDataPoints\": 100, \"nullPointMode\": \"connected\", \"nullText\": null, \"postfix\": \"\", \"postfixFontSize\": \"50%\", \"prefix\": \"\", \"prefixFontSize\": \"50%\", \"rangeMaps\": [ { \"from\": \"null\", \"text\": \"N\/A\", \"to\": \"null\" } ], \"sparkline\": { \"fillColor\": \"rgba(31, 118, 189, 0.18)\", \"full\": false, \"lineColor\": \"rgb(31, 120, 193)\", \"show\": true }, \"tableColumn\": \"\", \"targets\": [ { \"expr\": \"prometheus_local_storage_indexing_queue_length{instance=~\\\"$node\\\"}\", \"intervalFactor\": 2, \"refId\": \"A\" } ], \"thresholds\": \"500,4000\", \"title\": \"Internal Storage Queue Length\", \"type\": \"singlestat\", \"valueFontSize\": \"70%\", \"valueMaps\": [ { \"op\": \"=\", \"text\": \"Empty\", \"value\": \"0\" } ], \"valueName\": \"current\" }, { \"datasource\": null, \"editable\": true, \"error\": false, \"fieldConfig\": { \"defaults\": {}, \"overrides\": [] }, \"gridPos\": { \"h\": 5, \"w\": 6, \"x\": 18, \"y\": 0 }, \"id\": 9, \"links\": [], \"options\": { \"content\": \"<span style=\\\"font-family: 'Open Sans', 'Helvetica Neue', Helvetica; font-size: 25px;vertical-align: text-top;color: #bbbfc2;margin-left: 10px;\\\">Prometheus<\/span>\\n\\n<p style=\\\"margin-top: 10px;\\\">You're using Prometheus, an open-source systems monitoring and alerting toolkit originally built at SoundCloud. For more information, check out the <a href=\\\"https:\/\/grafana.com\/\\\">Grafana<\/a> and <a href=\\\"http:\/\/prometheus.io\/\\\">Prometheus<\/a> projects.<\/p>\", \"mode\": \"html\" }, \"pluginVersion\": \"7.5.3\", \"style\": {}, \"transparent\": true, \"type\": \"text\" }, { \"aliasColors\": { \"prometheus\": \"#C15C17\", \"{instance=\\\"localhost:9090\\\",job=\\\"prometheus\\\"}\": \"#C15C17\" }, \"bars\": false, \"dashLength\": 10, \"dashes\": false, \"datasource\": \"prometheus\", \"editable\": true, \"error\": false, \"fieldConfig\": { \"defaults\": { \"links\": [] }, \"overrides\": [] }, \"fill\": 1, \"fillGradient\": 0, \"grid\": {}, \"gridPos\": { \"h\": 6, \"w\": 18, \"x\": 0, \"y\": 5 }, \"hiddenSeries\": false, \"id\": 3, \"legend\": { \"avg\": false, \"current\": false, \"max\": false, \"min\": false, \"show\": true, \"total\": false, \"values\": false }, \"lines\": true, \"linewidth\": 2, \"links\": [], \"nullPointMode\": \"connected\", \"options\": { \"alertThreshold\": true }, \"percentage\": false, \"pluginVersion\": \"7.5.3\", \"pointradius\": 2, \"points\": false, \"renderer\": \"flot\", \"seriesOverrides\": [], \"spaceLength\": 10, \"stack\": false, \"steppedLine\": false, \"targets\": [ { \"expr\": \"rate(prometheus_local_storage_ingested_samples_total{instance=~\\\"$node\\\"}[5m])\", \"interval\": \"\", \"intervalFactor\": 2, \"legendFormat\": \"{{job}}\", \"metric\": \"\", \"refId\": \"A\" } ], \"thresholds\": [], \"timeFrom\": null, \"timeRegions\": [], \"timeShift\": null, \"title\": \"Samples ingested (rate-5m)\", \"tooltip\": { \"shared\": true, \"sort\": 0, \"value_type\": \"cumulative\" }, \"type\": \"graph\", \"xaxis\": { \"buckets\": null, \"mode\": \"time\", \"name\": null, \"show\": true, \"values\": [] }, \"yaxes\": [ { \"format\": \"short\", \"logBase\": 1, \"max\": null, \"min\": null, \"show\": true }, { \"format\": \"short\", \"logBase\": 1, \"max\": null, \"min\": null, \"show\": true } ], \"yaxis\": { \"align\": false, \"alignLevel\": null } }, { \"datasource\": null, \"editable\": true, \"error\": false, \"fieldConfig\": { \"defaults\": {}, \"overrides\": [] }, \"gridPos\": { \"h\": 6, \"w\": 4, \"x\": 18, \"y\": 5 }, \"id\": 8, \"links\": [], \"options\": { \"content\": \"#### Samples Ingested\\nThis graph displays the count of samples ingested by the Prometheus server, as measured over the last 5 minutes, per time series in the range vector. When troubleshooting an issue on IRC or GitHub, this is often the first stat requested by the Prometheus team. \", \"mode\": \"markdown\" }, \"pluginVersion\": \"7.5.3\", \"style\": {}, \"transparent\": true, \"type\": \"text\" }, { \"aliasColors\": { \"prometheus\": \"#F9BA8F\", \"{instance=\\\"localhost:9090\\\",interval=\\\"5s\\\",job=\\\"prometheus\\\"}\": \"#F9BA8F\" }, \"bars\": false, \"dashLength\": 10, \"dashes\": false, \"datasource\": \"prometheus\", \"editable\": true, \"error\": false, \"fieldConfig\": { \"defaults\": { \"links\": [] }, \"overrides\": [] }, \"fill\": 1, \"fillGradient\": 0, \"grid\": {}, \"gridPos\": { \"h\": 7, \"w\": 10, \"x\": 0, \"y\": 11 }, \"hiddenSeries\": false, \"id\": 2, \"legend\": { \"avg\": false, \"current\": false, \"max\": false, \"min\": false, \"show\": true, \"total\": false, \"values\": false }, \"lines\": true, \"linewidth\": 2, \"links\": [], \"nullPointMode\": \"connected\", \"options\": { \"alertThreshold\": true }, \"percentage\": false, \"pluginVersion\": \"7.5.3\", \"pointradius\": 5, \"points\": false, \"renderer\": \"flot\", \"seriesOverrides\": [], \"spaceLength\": 10, \"stack\": false, \"steppedLine\": false, \"targets\": [ { \"expr\": \"rate(prometheus_target_interval_length_seconds_count{instance=~\\\"$node\\\"}[5m])\", \"intervalFactor\": 2, \"legendFormat\": \"{{job}}\", \"refId\": \"A\" } ], \"thresholds\": [], \"timeFrom\": null, \"timeRegions\": [], \"timeShift\": null, \"title\": \"Target Scrapes (last 5m)\", \"tooltip\": { \"shared\": true, \"sort\": 0, \"value_type\": \"cumulative\" }, \"type\": \"graph\", \"xaxis\": { \"buckets\": null, \"mode\": \"time\", \"name\": null, \"show\": true, \"values\": [] }, \"yaxes\": [ { \"format\": \"short\", \"logBase\": 1, \"max\": null, \"min\": null, \"show\": true }, { \"format\": \"short\", \"logBase\": 1, \"max\": null, \"min\": null, \"show\": true } ], \"yaxis\": { \"align\": false, \"alignLevel\": null } }, { \"aliasColors\": {}, \"bars\": false, \"dashLength\": 10, \"dashes\": false, \"datasource\": \"prometheus\", \"editable\": true, \"error\": false, \"fieldConfig\": { \"defaults\": { \"links\": [] }, \"overrides\": [] }, \"fill\": 1, \"fillGradient\": 0, \"grid\": {}, \"gridPos\": { \"h\": 7, \"w\": 8, \"x\": 10, \"y\": 11 }, \"hiddenSeries\": false, \"id\": 14, \"legend\": { \"avg\": false, \"current\": false, \"max\": false, \"min\": false, \"show\": true, \"total\": false, \"values\": false }, \"lines\": true, \"linewidth\": 2, \"links\": [], \"nullPointMode\": \"connected\", \"options\": { \"alertThreshold\": true }, \"percentage\": false, \"pluginVersion\": \"7.5.3\", \"pointradius\": 5, \"points\": false, \"renderer\": \"flot\", \"seriesOverrides\": [], \"spaceLength\": 10, \"stack\": false, \"steppedLine\": false, \"targets\": [ { \"expr\": \"prometheus_target_interval_length_seconds{quantile!=\\\"0.01\\\", quantile!=\\\"0.05\\\",instance=~\\\"$node\\\"}\", \"interval\": \"\", \"intervalFactor\": 2, \"legendFormat\": \"{{quantile}} ({{interval}})\", \"metric\": \"\", \"refId\": \"A\" } ], \"thresholds\": [], \"timeFrom\": null, \"timeRegions\": [], \"timeShift\": null, \"title\": \"Scrape Duration\", \"tooltip\": { \"shared\": true, \"sort\": 0, \"value_type\": \"cumulative\" }, \"type\": \"graph\", \"xaxis\": { \"buckets\": null, \"mode\": \"time\", \"name\": null, \"show\": true, \"values\": [] }, \"yaxes\": [ { \"format\": \"short\", \"logBase\": 1, \"max\": null, \"min\": null, \"show\": true }, { \"format\": \"short\", \"logBase\": 1, \"max\": null, \"min\": null, \"show\": true } ], \"yaxis\": { \"align\": false, \"alignLevel\": null } }, { \"datasource\": null, \"editable\": true, \"error\": false, \"fieldConfig\": { \"defaults\": {}, \"overrides\": [] }, \"gridPos\": { \"h\": 7, \"w\": 6, \"x\": 18, \"y\": 11 }, \"id\": 11, \"links\": [], \"options\": { \"content\": \"#### Scrapes\\nPrometheus scrapes metrics from instrumented jobs, either directly or via an intermediary push gateway for short-lived jobs. Target scrapes will show how frequently targets are scraped, as measured over the last 5 minutes, per time series in the range vector. Scrape Duration will show how long the scrapes are taking, with percentiles available as series. \", \"mode\": \"markdown\" }, \"pluginVersion\": \"7.5.3\", \"style\": {}, \"transparent\": true, \"type\": \"text\" }, { \"aliasColors\": {}, \"bars\": false, \"dashLength\": 10, \"dashes\": false, \"datasource\": \"prometheus\", \"decimals\": null, \"editable\": true, \"error\": false, \"fieldConfig\": { \"defaults\": { \"links\": [] }, \"overrides\": [] }, \"fill\": 1, \"fillGradient\": 0, \"grid\": {}, \"gridPos\": { \"h\": 7, \"w\": 18, \"x\": 0, \"y\": 18 }, \"hiddenSeries\": false, \"id\": 12, \"legend\": { \"alignAsTable\": false, \"avg\": false, \"current\": false, \"hideEmpty\": true, \"max\": false, \"min\": false, \"show\": true, \"total\": false, \"values\": false }, \"lines\": true, \"linewidth\": 2, \"links\": [], \"nullPointMode\": \"connected\", \"options\": { \"alertThreshold\": true }, \"percentage\": false, \"pluginVersion\": \"7.5.3\", \"pointradius\": 5, \"points\": false, \"renderer\": \"flot\", \"seriesOverrides\": [], \"spaceLength\": 10, \"stack\": false, \"steppedLine\": false, \"targets\": [ { \"expr\": \"prometheus_evaluator_duration_seconds{quantile!=\\\"0.01\\\", quantile!=\\\"0.05\\\",instance=~\\\"$node\\\"}\", \"interval\": \"\", \"intervalFactor\": 2, \"legendFormat\": \"{{quantile}}\", \"refId\": \"A\" } ], \"thresholds\": [], \"timeFrom\": null, \"timeRegions\": [], \"timeShift\": null, \"title\": \"Rule Eval Duration\", \"tooltip\": { \"shared\": true, \"sort\": 0, \"value_type\": \"cumulative\" }, \"type\": \"graph\", \"xaxis\": { \"buckets\": null, \"mode\": \"time\", \"name\": null, \"show\": true, \"values\": [] }, \"yaxes\": [ { \"format\": \"percentunit\", \"label\": \"\", \"logBase\": 1, \"max\": null, \"min\": null, \"show\": true }, { \"format\": \"short\", \"logBase\": 1, \"max\": null, \"min\": null, \"show\": true } ], \"yaxis\": { \"align\": false, \"alignLevel\": null } }, { \"datasource\": null, \"editable\": true, \"error\": false, \"fieldConfig\": { \"defaults\": {}, \"overrides\": [] }, \"gridPos\": { \"h\": 7, \"w\": 6, \"x\": 18, \"y\": 18 }, \"id\": 15, \"links\": [], \"options\": { \"content\": \"#### Rule Evaluation Duration\\nThis graph panel plots the duration for all evaluations to execute. The 50th percentile, 90th percentile and 99th percentile are shown as three separate series to help identify outliers that may be skewing the data.\", \"mode\": \"markdown\" }, \"pluginVersion\": \"7.5.3\", \"style\": {}, \"transparent\": true, \"type\": \"text\" } ], \"refresh\": false, \"revision\": \"1.0\", \"schemaVersion\": 27, \"style\": \"dark\", \"tags\": [ \"prometheus\" ], \"templating\": { \"list\": [ { \"allValue\": null, \"current\": {}, \"datasource\": \"prometheus\", \"definition\": \"\", \"description\": null, \"error\": { \"config\": { \"headers\": { \"X-Grafana-Org-Id\": 2 }, \"hideFromInspector\": true, \"method\": \"GET\", \"retry\": 0, \"url\": \"api\/datasources\/proxy\/5\/api\/v1\/series?match%5B%5D=prometheus_build_info&start=1629266056&end=1629266356\" }, \"data\": { \"error\": \"\", \"message\": \"\", \"response\": \"\" }, \"message\": \"Query error: 502 \", \"status\": 502, \"statusText\": \"\" }, \"hide\": 0, \"includeAll\": false, \"label\": \"HOST:\", \"multi\": false, \"name\": \"node\", \"options\": [], \"query\": { \"query\": \"label_values(prometheus_build_info, instance)\", \"refId\": \"prometheus-node-Variable-Query\" }, \"refresh\": 1, \"regex\": \"\", \"skipUrlSync\": false, \"sort\": 1, \"tagValuesQuery\": \"\", \"tags\": [], \"tagsQuery\": \"\", \"type\": \"query\", \"useTags\": false } ] }, \"time\": { \"from\": \"now-5m\", \"to\": \"now\" }, \"timepicker\": { \"now\": true, \"refresh_intervals\": [ \"5s\", \"10s\", \"30s\", \"1m\", \"5m\", \"15m\", \"30m\", \"1h\", \"2h\", \"1d\" ], \"time_options\": [ \"5m\", \"15m\", \"1h\", \"6h\", \"12h\", \"24h\", \"2d\", \"7d\", \"30d\" ] }, \"timezone\": \"browser\", \"title\": \"Prometheus Stats\", \"uid\": \"5gNBzu6Gz\", \"version\": 1 }"

dashboards="[${lokiQuicksearchDashboard},${prometheusStatsDashboard}]"


#==========================CREATE ORGANISATION=================================
createOrgResponse=$(curl -s -w "%{http_code}" -X POST -H "Content-Type: application/json" -d "{\"name\":\"$tenantName\"}" https://$admin_user:$admin_pass@$url/api/orgs)

http_code=${createOrgResponse: -3} # get the last 3 digits
echo "- Create org: ${createOrgResponse}"

if [ $http_code -eq 409 ]
then
  #==========================STOP IF CREATED=================================
  echo "${tenantName} already exists! :-("
  exit 1;
elif [ $http_code -nq 200 ]
then
  #==========================STOP IF SOME OTHER ERROR=================================
  echo " something went wrong creating ${tenantName}. Result; ${createOrgResponse} ! :-("
  exit 1;
fi

#==========================IF NOT ALREADY CREATED=================================

# Add admin to new organisation
orgId=$(echo ${createOrgResponse} | head -c-4 | jq -r '.orgId')  # get all but the last 3 digits
addUserToNewOrgResponseCode=$(curl --write-out '%{http_code}' --silent  -X POST -H "Content-Type: application/json" -d "{\"loginOrEmail\":\"$tenantName\",\"role\":\"Admin\"}" https://$admin_user:$admin_pass@$url/api/orgs/$orgId)
echo "- Add $admin_user to org $orgId : ${addUserToNewOrgResponseCode}"

# Switch organisation to new one
switchContextResult=$(curl --write-out '%{http_code}' --silent -X POST -H "Content-Type: application/json" https://$admin_user:$admin_pass@$url/api/user/using/$orgId)
echo "- context-switching: ${switchContextResult}"

# Create api key
createApiKeyResult=$(curl --write-out '%{http_code}' --silent -X POST -H "Content-Type: application/json" -d "{\"name\":\"apikeycurl\",\"role\":\"Admin\"}" https://$admin_user:$admin_pass@$url/api/auth/keys)
apikey=$(echo ${createApiKeyResult} | head -c-4 | jq -r '.key')  # get all but the last 3 digits
echo "- Apikey: ${createApiKeyResult}"

# Create datasource
createLokiDatasourceResult=$(curl --write-out '%{http_code}' --silent -X POST -H "Authorization: Bearer $apikey" -H "Content-Type: application/json" -d "{\"name\":\"Loki\",\"type\":\"loki\",\"url\":\"http://${tenantName}-loki.${tenantName}.svc.cluster.local:3100\",\"access\":\"proxy\",\"basicAuth\":false}" https://$url/api/datasources)
echo "- Loki: ${createLokiDatasourceResult}"

createPrometheusDatasourceResult=$(curl --write-out '%{http_code}' --silent -X POST -H "Authorization: Bearer $apikey" -H "Content-Type: application/json" -d "{\"name\":\"prometheus\",\"type\":\"prometheus\",\"url\":\"http://${tenantName}-prometheus-server.${tenantName}.svc.cluster.local\",\"access\":\"proxy\",\"basicAuth\":false}" https://$url/api/datasources)
echo "- Prometheus: ${createPrometheusDatasourceResult}"

# Create dashboard
for dashboard in $(echo "${dashboards}" | jq -r '.[] | @base64'); do
    _jq() {
     echo ${dashboard} | base64 --decode | jq -r ${1}
    }

    dashboardUrl="https://$url/api/dashboards/db"
    createDashboardResult=$(curl --write-out '%{http_code}' --silent  -X POST -H "Authorization: Bearer $apikey" -H "Content-Type: application/json" -d "{\"dashboard\": $(_jq)}" $dashboardUrl)
    echo "- Create dashboard ($(_jq '.title')): ${createDashboardResult}"

done
